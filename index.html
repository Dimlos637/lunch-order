<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€ å‹ä¸­é¤é»é¤ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --main-green: #556b2f; --bg-color: #f4f7f4; --accent-brown: #8b4513; }
        body { background-color: var(--bg-color); padding: 20px; font-family: "Microsoft JhengHei", sans-serif; }
        
        /* æå‡è³ªæ„Ÿå¾Œçš„å¡ç‰‡æ¨£å¼ */
        .order-card { 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.08); 
            padding: 30px; 
            max-width: 500px; 
            margin: auto; 
            border-top: 10px solid var(--main-green);
            transition: all 0.5s ease;
        }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-submit { background-color: var(--main-green); color: white; width: 100%; border-radius: 30px; border: none; padding: 12px; font-weight: bold; transition: 0.3s; }
        .btn-submit:hover { background-color: #3e4f22; transform: translateY(-2px); }
        .btn-submit:disabled { background-color: #a0a0a0; }
        
        /* æ’¤å›æŒ‰éˆ•æ¨£å¼ */
        .btn-withdraw { background-color: transparent; color: #666; width: 100%; border-radius: 30px; padding: 8px; font-size: 0.9rem; border: 1px solid #ccc; margin-top: 15px; transition: 0.3s; }
        .btn-withdraw:hover { background-color: #fff0f0; color: #c92a2a; border-color: #c92a2a; }

        .price-tag { color: var(--main-green); font-weight: bold; font-size: 1.4rem; }
        #paymentSection { background-color: #f0f4ee; border-left: 5px solid var(--main-green); display: none; padding: 15px; border-radius: 8px; margin-top:15px; }
        .notice-box { background-color: #fff9db; border: 1px dashed #fab005; padding: 10px; border-radius: 8px; font-size: 0.85rem; color: #856404; }
        .warning-text { color: #d9534f; font-weight: bold; font-size: 0.85rem; display: none; }
        .form-label { font-weight: bold; color: #333; }
    </style>
</head>
<body>

<div class="container">
    <div id="loading" class="text-center py-5">
        <div class="spinner-border text-success"></div>
        <p class="mt-2 text-secondary">æ­£åœ¨åŒæ­¥ä»Šæ—¥èœå–®...</p>
    </div>

    <div id="formSection" class="order-card" style="display:none;">
        <h3 class="text-center mb-1" id="resTitle" style="color: var(--main-green); font-weight: 900;">è¼‰å…¥ä¸­...</h3>
        <p class="text-center text-secondary small mb-4">é€ å‹ä¸­é¤é»é¤ç³»çµ±</p>
        
        <form id="orderForm">
            <div class="mb-3">
                <label class="form-label">æ‚¨çš„å§“å</label>
                <input type="text" id="userName" class="form-control" placeholder="è«‹è¼¸å…¥åå­—" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label">é¸æ“‡å“é …</label>
                <select id="menuSelect" class="form-select" required></select>
            </div>

            <div class="mb-3">
                <label class="form-label">æ•¸é‡</label>
                <input type="number" id="quantityInput" class="form-control" value="1" min="1" required>
                <div id="priceDisplay" class="mt-2 text-end"></div>
                <div id="qtyWarning" class="warning-text text-end mt-1">âš ï¸ æ­¤å“é …å–®åƒ¹å« 0.5 å…ƒï¼Œæ•¸é‡è«‹é»é¸ã€Œé›™æ•¸ã€</div>
            </div>

            <div class="mb-3">
                <label class="form-label">å‚™è¨»</label>
                <input type="text" id="note" class="form-control" placeholder="é£¯å°‘ã€ä¸è¦è¾£ã€æˆ–æ˜¯åŠ é»...">
            </div>

            <div class="mb-3 form-check">
                <input type="checkbox" class="form-check-input" id="paidCheck">
                <label class="form-check-label fw-bold" for="paidCheck" style="color: var(--main-green);"> æˆ‘å·²ç¾å ´ç¹³è²» </label>
            </div>

            <div id="paymentSection">
                <label class="form-label small">æ”¶å–é‡‘é¡</label>
                <input type="number" id="receivedAmount" class="form-control mb-2" placeholder="è«‹è¼¸å…¥é¢é¡">
                <div class="fw-bold text-end" style="color: var(--accent-brown);">æ‰¾é›¶ï¼š<span id="changeAmount">$0</span></div>
            </div>

            <div class="notice-box mt-4">
                <strong>ğŸ’¡ æé†’ï¼š</strong> å¦‚æ¬²ä¿®æ”¹ï¼Œç›´æ¥é‡æ–°ä¸‹å–®å³å¯è¦†è“‹èˆŠå–®ã€‚è‹¥è¦å–æ¶ˆï¼Œè«‹è¼¸å…¥å§“åå¾Œé»æ“Šä¸‹æ–¹çš„ã€Œæ’¤å›è¨‚å–®ã€ã€‚
            </div>

            <button type="submit" id="submitBtn" class="btn btn-submit mt-4">ç¢ºèªä¸‹å–®</button>
            <button type="button" id="withdrawBtn" class="btn btn-withdraw">ğŸ”™ æ’¤å›æˆ‘çš„æœ€å¾Œä¸€ç­†è¨‚å–®</button>
        </form>
        <div id="msg" class="text-center mt-3 fw-bold"></div>
    </div>

    <div id="closedSection" class="order-card text-center py-5" style="display:none;">
        <h2 style="color: var(--main-green); font-weight: bold;">ğŸ›‘ ä»Šæ—¥é»é¤å·²æˆªæ­¢</h2>
        <div class="mt-3 p-3 mx-auto" style="max-width: 320px; background-color: #fff5f5; border-radius: 15px; border: 1px solid #ffc9c9;">
            <p class="mb-1 fw-bold" style="color: #c92a2a;">ç³»çµ±é–‹æ”¾æ™‚é–“</p>
            <p class="mb-0 fs-6" style="color: #c92a2a; letter-spacing: 1px;">é€±ä¸€ ~ é€±äº” 07:00 ~ 08:45</p>
        </div>
        <p class="text-secondary mt-4 small">ï¼ˆåœ‹å®šå‡æ—¥åŠé€±æœ«ä¸é–‹æ”¾é»é¤ï¼‰</p>
    </div>
</div>

<script>
    // --- âš ï¸ é‡è¦ï¼šè«‹æ›¿æ›æˆä½ çš„ GAS ç¶²å€ âš ï¸ ---
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyueRiA8FDP84WutZ3XtQ-XyGbusGo4WFgV1Qwa0IqEOsSA3Uky44r9otrA30rqDJ7iYA/exec"; 
    
    let menuStore = [], currentUnitPrice = 0;

    // é é¢å•Ÿå‹•è¼‰å…¥é¸å–®
    window.onload = () => {
        fetch(GAS_URL).then(res => res.json()).then(data => {
            document.getElementById('loading').style.display = 'none';
            if (data.status !== "é–‹å•Ÿ") { document.getElementById('closedSection').style.display = 'block'; return; }
            document.getElementById('formSection').style.display = 'block';
            document.getElementById('resTitle').innerText = "ğŸ± ä»Šæ—¥é¤å»³ï¼š" + data.restaurant;
            
            menuStore = data.menu;
            const select = document.getElementById('menuSelect');
            select.add(new Option("-- è«‹é¸æ“‡å“é … --", ""));
            data.menu.forEach((row, i) => { 
                if(row[0]) { 
                    let opt = new Option(`${row[0]} ($${row[1]})`, row[0]); 
                    opt.dataset.idx = i; 
                    select.add(opt); 
                } 
            });
        });
    };

    // æ›´æ–°åƒ¹æ ¼èˆ‡ 0.5 å…ƒé˜²å‘†æª¢æŸ¥
    function updatePrice() {
        const qtyInput = document.getElementById('quantityInput');
        let qty = parseInt(qtyInput.value) || 1;
        if (qty < 1) qty = 1;
        
        const total = currentUnitPrice * qty;
        const warning = document.getElementById('qtyWarning');
        
        // æª¢æŸ¥ 0.5 å…ƒé˜²å‘†ï¼šå–®åƒ¹å« 0.5 ä¸”æ•¸é‡ç‚ºå¥‡æ•¸æ™‚é¡¯ç¤ºè­¦å‘Š
        if (currentUnitPrice % 1 !== 0 && qty % 2 !== 0) {
            warning.style.display = 'block';
        } else {
            warning.style.display = 'none';
        }

        if(currentUnitPrice > 0) {
            document.getElementById('priceDisplay').innerHTML = `ç¸½è¨ˆ <span class="price-tag">$${total}</span>`;
        }
        calcChange(total);
    }

    document.getElementById('menuSelect').onchange = function() {
        const idx = this.options[this.selectedIndex].dataset.idx;
        if (idx !== undefined) { 
            currentUnitPrice = menuStore[idx][1]; 
            updatePrice(); 
        }
    };

    document.getElementById('quantityInput').oninput = updatePrice;
    document.getElementById('receivedAmount').oninput = updatePrice;
    document.getElementById('paidCheck').onchange = function() {
        document.getElementById('paymentSection').style.display = this.checked ? 'block' : 'none';
    };

    function calcChange(total) {
        const received = parseFloat(document.getElementById('receivedAmount').value) || 0;
        const change = received - total;
        document.getElementById('changeAmount').innerText = change >= 0 ? `$${change}` : "é‡‘é¡ä¸è¶³";
    }

    // --- æäº¤è¨‚å–®é‚è¼¯ ---
    document.getElementById('orderForm').onsubmit = function(e) {
        e.preventDefault();
        
        const qty = parseInt(document.getElementById('quantityInput').value);
        if (currentUnitPrice % 1 !== 0 && qty % 2 !== 0) {
            alert("âš ï¸ æ•¸é‡éŒ¯èª¤ï¼šå–®åƒ¹æœ‰ 0.5 å…ƒï¼Œè«‹é»é¸ã€Œé›™æ•¸ã€ä»¥ä¾¿çµå¸³æ”¶è²»ã€‚");
            return;
        }

        const btn = document.getElementById('submitBtn');
        const msg = document.getElementById('msg');
        btn.disabled = true; btn.innerText = "ä¸‹å–®å‚³é€ä¸­...";
        
        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({
                userName: document.getElementById('userName').value,
                item: document.getElementById('menuSelect').value,
                price: currentUnitPrice,
                quantity: qty,
                note: document.getElementById('note').value,
                hasPaid: document.getElementById('paidCheck').checked,
                receivedAmount: document.getElementById('receivedAmount').value
            })
        }).then(res => res.json()).then(res => {
            msg.className = res.result.includes("å¤±æ•—") ? "text-center mt-3 fw-bold text-danger" : "text-center mt-3 fw-bold text-success";
            msg.innerText = res.result;
            if (!res.result.includes("å¤±æ•—")) {
                this.reset();
                document.getElementById('paymentSection').style.display = 'none';
                document.getElementById('priceDisplay').innerText = "";
                document.getElementById('quantityInput').value = 1;
            }
            btn.disabled = false; btn.innerText = "ç¢ºèªä¸‹å–®";
            setTimeout(() => { msg.innerText = ""; }, 5000);
        }).catch(err => {
            msg.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
            btn.disabled = false; btn.innerText = "ç¢ºèªä¸‹å–®";
        });
    };

    // --- ğŸ”™ æ’¤å›è¨‚å–®é‚è¼¯ ---
    document.getElementById('withdrawBtn').onclick = function() {
        const name = document.getElementById('userName').value.trim();
        if (!name) { alert("è«‹å…ˆè¼¸å…¥æ‚¨çš„å§“åï¼Œä»¥ä¾¿ç³»çµ±æŸ¥æ‰¾è¨‚å–®ã€‚"); return; }
        if (!confirm("ç¢ºå®šè¦æ’¤å› " + name + " çš„æœ€å¾Œä¸€ç­†è¨‚å–®å—ï¼Ÿ")) return;
        
        const btn = this;
        btn.disabled = true; btn.innerText = "æ­£åœ¨æ’¤å›...";
        
        fetch(GAS_URL, {
            method: 'POST',
            body: JSON.stringify({ action: "delete", userName: name })
        })
        .then(res => res.json()).then(res => {
            alert(res.result);
            btn.disabled = false; btn.innerText = "ğŸ”™ æ’¤å›æˆ‘çš„æœ€å¾Œä¸€ç­†è¨‚å–®";
        }).catch(err => {
            alert("æ’¤å›å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            btn.disabled = false; btn.innerText = "ğŸ”™ æ’¤å›æˆ‘çš„æœ€å¾Œä¸€ç­†è¨‚å–®";
        });
    };
</script>
</body>
</html>
